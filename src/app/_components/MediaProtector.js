'use client';

import { useCallback, useEffect, useRef } from 'react';
import { useContentWarningConsent } from '@/app/_contexts/ContentWarningConsentContext';
import { trackContentWarningConsent } from '@/app/_helpers/gtag';
import styles from '@app/_assets/media-protector.module.css';

const ConsentIcon = () => {
  return (
    <svg width="17" height="15" viewBox="0 0 17 15" fill="none" xmlns="http://www.w3.org/2000/svg">
      <mask id="path-1-outside-1_900_4479" maskUnits="userSpaceOnUse" x="-0.580078" y="-0.575684" width="18" height="15" fill="black">
        <rect fill="white" x="-0.580078" y="-0.575684" width="18" height="15" />
        <path d="M15.1094 0.523926L2.02148 13.6118L1.92188 13.5122L15.0098 0.424316L15.1094 0.523926ZM12.8887 4.52979C13.2881 5.25255 13.5155 6.08399 13.5156 6.96826C13.5155 9.31761 11.9111 11.2917 9.73828 11.856C12.2136 11.6305 14.5017 10.7578 16.4287 9.40381L16.5098 9.51904C14.2332 11.1186 11.4583 12.058 8.46484 12.0581C7.49939 12.0581 6.55702 11.958 5.64648 11.772L5.76758 11.6509C6.23452 11.7427 6.7099 11.8121 7.19238 11.856C6.78142 11.7492 6.39064 11.5917 6.02734 11.3911L6.13086 11.2876C6.82516 11.6639 7.62068 11.8774 8.46582 11.8774C11.1763 11.8772 13.3739 9.6788 13.374 6.96826C13.3739 6.12352 13.1601 5.32837 12.7842 4.63428L12.8887 4.52979ZM0.500977 9.40381C1.20704 9.89986 1.96247 10.3303 2.75684 10.689L2.64941 10.7964C1.865 10.4379 1.1186 10.0099 0.419922 9.51904L0.459961 9.46143L0.500977 9.40381ZM8.46484 1.87939C9.4298 1.87941 10.3721 1.9777 11.2822 2.16357L11.1602 2.28564C10.6942 2.19399 10.2197 2.12441 9.73828 2.08057C10.1485 2.1871 10.5387 2.34435 10.9014 2.54443L10.7979 2.64795C10.1043 2.27277 9.30965 2.06014 8.46582 2.06006C5.75528 2.06012 3.55801 4.2578 3.55762 6.96826C3.55767 7.81199 3.77049 8.60671 4.14551 9.30029L4.04102 9.40479C3.64228 8.68252 3.41509 7.85171 3.41504 6.96826C3.41537 4.61948 5.01925 2.64519 7.19141 2.08057C4.71594 2.30597 2.42809 3.1797 0.500977 4.53369L0.460938 4.47607L0.419922 4.41846C2.69655 2.81888 5.47124 1.87941 8.46484 1.87939ZM14.2783 3.14014C15.0635 3.4988 15.8105 3.92713 16.5098 4.41846L16.4287 4.53369C15.7222 4.03729 14.9668 3.60558 14.1719 3.24658L14.2783 3.14014Z" />
      </mask>
      <path d="M15.1094 0.523926L2.02148 13.6118L1.92188 13.5122L15.0098 0.424316L15.1094 0.523926ZM12.8887 4.52979C13.2881 5.25255 13.5155 6.08399 13.5156 6.96826C13.5155 9.31761 11.9111 11.2917 9.73828 11.856C12.2136 11.6305 14.5017 10.7578 16.4287 9.40381L16.5098 9.51904C14.2332 11.1186 11.4583 12.058 8.46484 12.0581C7.49939 12.0581 6.55702 11.958 5.64648 11.772L5.76758 11.6509C6.23452 11.7427 6.7099 11.8121 7.19238 11.856C6.78142 11.7492 6.39064 11.5917 6.02734 11.3911L6.13086 11.2876C6.82516 11.6639 7.62068 11.8774 8.46582 11.8774C11.1763 11.8772 13.3739 9.6788 13.374 6.96826C13.3739 6.12352 13.1601 5.32837 12.7842 4.63428L12.8887 4.52979ZM0.500977 9.40381C1.20704 9.89986 1.96247 10.3303 2.75684 10.689L2.64941 10.7964C1.865 10.4379 1.1186 10.0099 0.419922 9.51904L0.459961 9.46143L0.500977 9.40381ZM8.46484 1.87939C9.4298 1.87941 10.3721 1.9777 11.2822 2.16357L11.1602 2.28564C10.6942 2.19399 10.2197 2.12441 9.73828 2.08057C10.1485 2.1871 10.5387 2.34435 10.9014 2.54443L10.7979 2.64795C10.1043 2.27277 9.30965 2.06014 8.46582 2.06006C5.75528 2.06012 3.55801 4.2578 3.55762 6.96826C3.55767 7.81199 3.77049 8.60671 4.14551 9.30029L4.04102 9.40479C3.64228 8.68252 3.41509 7.85171 3.41504 6.96826C3.41537 4.61948 5.01925 2.64519 7.19141 2.08057C4.71594 2.30597 2.42809 3.1797 0.500977 4.53369L0.460938 4.47607L0.419922 4.41846C2.69655 2.81888 5.47124 1.87941 8.46484 1.87939ZM14.2783 3.14014C15.0635 3.4988 15.8105 3.92713 16.5098 4.41846L16.4287 4.53369C15.7222 4.03729 14.9668 3.60558 14.1719 3.24658L14.2783 3.14014Z" fill="currentColor" fillOpacity="0.75" />
      <path d="M15.1094 0.523926L15.3215 0.736058L15.5336 0.523926L15.3215 0.311794L15.1094 0.523926ZM2.02148 13.6118L1.80935 13.8239L2.02148 14.0361L2.23362 13.8239L2.02148 13.6118ZM1.92188 13.5122L1.70974 13.3001L1.49761 13.5122L1.70974 13.7243L1.92188 13.5122ZM15.0098 0.424316L15.2219 0.212184L15.0098 5.23329e-05L14.7976 0.212184L15.0098 0.424316ZM12.8887 4.52979L13.1513 4.38469L12.9584 4.03575L12.6765 4.31765L12.8887 4.52979ZM13.5156 6.96826L13.8156 6.96828V6.96822L13.5156 6.96826ZM9.73828 11.856L9.66287 11.5656L9.7655 12.1547L9.73828 11.856ZM16.4287 9.40381L16.6741 9.23121L16.5016 8.98596L16.2562 9.15834L16.4287 9.40381ZM16.5098 9.51904L16.6822 9.76451L16.9278 9.59195L16.7551 9.34645L16.5098 9.51904ZM8.46484 12.0581L8.46484 12.3581H8.46485L8.46484 12.0581ZM5.64648 11.772L5.43435 11.5598L5.03996 11.9542L5.58642 12.0659L5.64648 11.772ZM5.76758 11.6509L5.82548 11.3565L5.66854 11.3257L5.55545 11.4387L5.76758 11.6509ZM7.19238 11.856L7.1652 12.1547L7.26782 11.5656L7.19238 11.856ZM6.02734 11.3911L5.81521 11.179L5.53324 11.461L5.88232 11.6537L6.02734 11.3911ZM6.13086 11.2876L6.2738 11.0238L6.07701 10.9172L5.91873 11.0755L6.13086 11.2876ZM8.46582 11.8774L8.46581 12.1774H8.46585L8.46582 11.8774ZM13.374 6.96826L13.674 6.96828V6.96822L13.374 6.96826ZM12.7842 4.63428L12.572 4.42215L12.4138 4.58038L12.5204 4.77716L12.7842 4.63428ZM0.500977 9.40381L0.673437 9.15833L0.429481 8.98694L0.256577 9.22983L0.500977 9.40381ZM2.75684 10.689L2.96897 10.9011L3.2759 10.5942L2.88029 10.4155L2.75684 10.689ZM2.64941 10.7964L2.52472 11.0692L2.71422 11.1558L2.86155 11.0085L2.64941 10.7964ZM0.419922 9.51904L0.173565 9.34785L0.00324759 9.59294L0.247458 9.76451L0.419922 9.51904ZM0.459961 9.46143L0.215546 9.28744L0.213604 9.29023L0.459961 9.46143ZM8.46484 1.87939L8.46485 1.57939L8.46484 1.57939L8.46484 1.87939ZM11.2822 2.16357L11.4944 2.37571L11.8888 1.98126L11.3423 1.86964L11.2822 2.16357ZM11.1602 2.28564L11.1023 2.58L11.2592 2.61087L11.3723 2.49778L11.1602 2.28564ZM9.73828 2.08057L9.76549 1.7818L9.66287 2.37093L9.73828 2.08057ZM10.9014 2.54443L11.1135 2.75657L11.3956 2.47445L11.0463 2.28175L10.9014 2.54443ZM10.7979 2.64795L10.6551 2.91182L10.8518 3.01823L11.01 2.86008L10.7979 2.64795ZM8.46582 2.06006L8.46585 1.76006L8.46581 1.76006L8.46582 2.06006ZM3.55762 6.96826L3.25762 6.96822V6.96828L3.55762 6.96826ZM4.14551 9.30029L4.35764 9.51243L4.51576 9.35431L4.4094 9.15761L4.14551 9.30029ZM4.04102 9.40479L3.77838 9.54978L3.97113 9.89893L4.25315 9.61692L4.04102 9.40479ZM3.41504 6.96826L3.11504 6.96822V6.96828L3.41504 6.96826ZM7.19141 2.08057L7.26688 2.37092L7.1642 1.7818L7.19141 2.08057ZM0.500977 4.53369L0.25462 4.70489L0.426703 4.95252L0.673443 4.77916L0.500977 4.53369ZM0.460938 4.47607L0.70731 4.30487L0.705337 4.30209L0.460938 4.47607ZM0.419922 4.41846L0.247453 4.17299L0.000466257 4.34652L0.175522 4.59244L0.419922 4.41846ZM14.2783 3.14014L14.403 2.86726L14.2135 2.78071L14.0662 2.928L14.2783 3.14014ZM16.5098 4.41846L16.7551 4.59105L16.9278 4.34555L16.6822 4.17299L16.5098 4.41846ZM16.4287 4.53369L16.2562 4.77916L16.5016 4.95154L16.6741 4.70629L16.4287 4.53369ZM14.1719 3.24658L13.9597 3.03445L13.6528 3.34136L14.0484 3.51999L14.1719 3.24658ZM15.1094 0.523926L14.8972 0.311794L1.80935 13.3997L2.02148 13.6118L2.23362 13.8239L15.3215 0.736058L15.1094 0.523926ZM2.02148 13.6118L2.23362 13.3997L2.13401 13.3001L1.92188 13.5122L1.70974 13.7243L1.80935 13.8239L2.02148 13.6118ZM1.92188 13.5122L2.13401 13.7243L15.2219 0.636448L15.0098 0.424316L14.7976 0.212184L1.70974 13.3001L1.92188 13.5122ZM15.0098 0.424316L14.7976 0.636448L14.8972 0.736058L15.1094 0.523926L15.3215 0.311794L15.2219 0.212184L15.0098 0.424316ZM12.8887 4.52979L12.6261 4.67488C13.0016 5.35437 13.2155 6.13604 13.2156 6.9683L13.5156 6.96826L13.8156 6.96822C13.8155 6.03194 13.5745 5.15074 13.1513 4.38469L12.8887 4.52979ZM13.5156 6.96826L13.2156 6.96824C13.2155 9.17757 11.7067 11.0348 9.66287 11.5656L9.73828 11.856L9.81369 12.1463C12.1154 11.5486 13.8155 9.45764 13.8156 6.96828L13.5156 6.96826ZM9.73828 11.856L9.7655 12.1547C12.2943 11.9244 14.6322 11.0327 16.6012 9.64928L16.4287 9.40381L16.2562 9.15834C14.3711 10.4829 12.1329 11.3366 9.71107 11.5572L9.73828 11.856ZM16.4287 9.40381L16.1833 9.57641L16.2644 9.69164L16.5098 9.51904L16.7551 9.34645L16.6741 9.23121L16.4287 9.40381ZM16.5098 9.51904L16.3373 9.27358C14.1096 10.8388 11.3946 11.758 8.46484 11.7581L8.46484 12.0581L8.46485 12.3581C11.5221 12.358 14.3568 11.3984 16.6822 9.76451L16.5098 9.51904ZM8.46484 12.0581L8.46484 11.7581C7.52018 11.7581 6.59793 11.6602 5.70654 11.478L5.64648 11.772L5.58642 12.0659C6.51611 12.2559 7.4786 12.3581 8.46484 12.3581L8.46484 12.0581ZM5.64648 11.772L5.85862 11.9841L5.97971 11.863L5.76758 11.6509L5.55545 11.4387L5.43435 11.5598L5.64648 11.772ZM5.76758 11.6509L5.70968 11.9452C6.1864 12.039 6.67204 12.1099 7.1652 12.1547L7.19238 11.856L7.21956 11.5572C6.74777 11.5143 6.28264 11.4464 5.82548 11.3565L5.76758 11.6509ZM7.19238 11.856L7.26782 11.5656C6.88155 11.4652 6.51412 11.3172 6.17237 11.1285L6.02734 11.3911L5.88232 11.6537C6.26716 11.8663 6.68128 12.0331 7.11695 12.1463L7.19238 11.856ZM6.02734 11.3911L6.23948 11.6032L6.34299 11.4997L6.13086 11.2876L5.91873 11.0755L5.81521 11.179L6.02734 11.3911ZM6.13086 11.2876L5.98792 11.5514C6.72505 11.9508 7.56957 12.1774 8.46581 12.1774L8.46582 11.8774L8.46583 11.5774C7.67179 11.5774 6.92527 11.3769 6.2738 11.0238L6.13086 11.2876ZM8.46582 11.8774L8.46585 12.1774C11.3421 12.1772 13.6738 9.84442 13.674 6.96828L13.374 6.96826L13.074 6.96824C13.0739 9.51318 11.0106 11.5772 8.46579 11.5774L8.46582 11.8774ZM13.374 6.96826L13.674 6.96822C13.6739 6.07232 13.4471 5.22821 13.048 4.4914L12.7842 4.63428L12.5204 4.77716C12.8732 5.42852 13.0739 6.17472 13.074 6.96831L13.374 6.96826ZM12.7842 4.63428L12.9963 4.84641L13.1008 4.74192L12.8887 4.52979L12.6765 4.31765L12.572 4.42215L12.7842 4.63428ZM0.500977 9.40381L0.328516 9.64928C1.05014 10.1563 1.82199 10.596 2.63338 10.9624L2.75684 10.689L2.88029 10.4155C2.10294 10.0646 1.36394 9.64345 0.673437 9.15833L0.500977 9.40381ZM2.75684 10.689L2.5447 10.4768L2.43728 10.5843L2.64941 10.7964L2.86155 11.0085L2.96897 10.9011L2.75684 10.689ZM2.64941 10.7964L2.77411 10.5235C2.00636 10.1727 1.27596 9.75383 0.592385 9.27357L0.419922 9.51904L0.247458 9.76451C0.961248 10.266 1.72365 10.7032 2.52472 11.0692L2.64941 10.7964ZM0.419922 9.51904L0.666279 9.69024L0.706318 9.63262L0.459961 9.46143L0.213604 9.29023L0.173565 9.34785L0.419922 9.51904ZM0.459961 9.46143L0.704361 9.63541L0.745376 9.57779L0.500977 9.40381L0.256577 9.22983L0.215561 9.28745L0.459961 9.46143ZM8.46484 1.87939L8.46484 2.17939C9.40938 2.17941 10.3316 2.27562 11.2222 2.45751L11.2822 2.16357L11.3423 1.86964C10.4127 1.67979 9.45022 1.57941 8.46485 1.57939L8.46484 1.87939ZM11.2822 2.16357L11.0701 1.95144L10.948 2.07351L11.1602 2.28564L11.3723 2.49778L11.4944 2.37571L11.2822 2.16357ZM11.1602 2.28564L11.2181 1.99128C10.7424 1.89774 10.2578 1.82664 9.76549 1.7818L9.73828 2.08057L9.71107 2.37933C10.1817 2.42219 10.6459 2.49024 11.1023 2.58L11.1602 2.28564ZM9.73828 2.08057L9.66287 2.37093C10.0484 2.47104 10.4152 2.61887 10.7565 2.80712L10.9014 2.54443L11.0463 2.28175C10.6621 2.06984 10.2487 1.90316 9.81369 1.7902L9.73828 2.08057ZM10.9014 2.54443L10.6892 2.3323L10.5857 2.43582L10.7979 2.64795L11.01 2.86008L11.1135 2.75657L10.9014 2.54443ZM10.7979 2.64795L10.9406 2.38408C10.2042 1.98572 9.3606 1.76014 8.46585 1.76006L8.46582 2.06006L8.46579 2.36006C9.25869 2.36013 10.0044 2.55982 10.6551 2.91182L10.7979 2.64795ZM8.46582 2.06006L8.46581 1.76006C5.58956 1.76013 3.25804 4.09215 3.25762 6.96822L3.55762 6.96826L3.85762 6.96831C3.85799 4.42346 5.92101 2.36012 8.46583 2.36006L8.46582 2.06006ZM3.55762 6.96826L3.25762 6.96828C3.25767 7.86299 3.48346 8.7066 3.88161 9.44298L4.14551 9.30029L4.4094 9.15761C4.05752 8.50681 3.85767 7.76099 3.85762 6.96824L3.55762 6.96826ZM4.14551 9.30029L3.93338 9.08816L3.82888 9.19265L4.04102 9.40479L4.25315 9.61692L4.35764 9.51243L4.14551 9.30029ZM4.04102 9.40479L4.30365 9.25979C3.92878 8.58076 3.71509 7.79968 3.71504 6.96824L3.41504 6.96826L3.11504 6.96828C3.1151 7.90374 3.35578 8.78427 3.77838 9.54978L4.04102 9.40479ZM3.41504 6.96826L3.71504 6.9683C3.71535 4.75946 5.22367 2.90202 7.26688 2.37092L7.19141 2.08057L7.11593 1.79022C4.81483 2.38836 3.11539 4.4795 3.11504 6.96822L3.41504 6.96826ZM7.19141 2.08057L7.1642 1.7818C4.63517 2.01208 2.29746 2.90484 0.32851 4.28822L0.500977 4.53369L0.673443 4.77916C2.55873 3.45456 4.79672 2.59986 7.21861 2.37933L7.19141 2.08057ZM0.500977 4.53369L0.747333 4.36249L0.707294 4.30488L0.460938 4.47607L0.214581 4.64727L0.25462 4.70489L0.500977 4.53369ZM0.460938 4.47607L0.705337 4.30209L0.664321 4.24448L0.419922 4.41846L0.175522 4.59244L0.216538 4.65005L0.460938 4.47607ZM0.419922 4.41846L0.59239 4.66393C2.82018 3.09866 5.53498 2.17941 8.46485 2.17939L8.46484 1.87939L8.46484 1.57939C5.4075 1.57941 2.57292 2.53909 0.247453 4.17299L0.419922 4.41846ZM14.2783 3.14014L14.403 2.86726L14.2135 2.78071L14.0662 2.928L14.2783 3.14014ZM16.5098 4.41846L16.2644 4.24586L16.1833 4.36109L16.4287 4.53369L16.6741 4.70629L16.7551 4.59105L16.5098 4.41846ZM16.4287 4.53369L16.6012 4.28822C15.8793 3.78104 15.1075 3.33995 14.2953 2.97317L14.1719 3.24658L14.0484 3.51999C14.8261 3.8712 15.5651 4.29355 16.2562 4.77916L16.4287 4.53369ZM14.1719 3.24658L14.384 3.45871L14.4905 3.35227L14.2783 3.14014L14.0662 2.928L13.9597 3.03445L14.1719 3.24658Z" fill="currentColor" fillOpacity="0.75" mask="url(#path-1-outside-1_900_4479)" />
    </svg>
  );
};

/**
 * MediaProtector â€“ only renders when contentWarning is true and user hasn't consented.
 */
export function MediaProtector({ contentWarning, className = '' }) {
  const { hasConsent, setConsent, isMounted } = useContentWarningConsent();
  const buttonRef = useRef(null);

  const handleContextMenu = useCallback((e) => {
    e.preventDefault();
  }, []);

  const handleDragStart = useCallback((e) => {
    e.preventDefault();
  }, []);

  const handleAccept = useCallback(() => {
    trackContentWarningConsent();
    setConsent();
  }, [setConsent]);

  // Focus button when overlay appears for better keyboard navigation
  useEffect(() => {
    if (!isMounted || hasConsent || !contentWarning) return;
    // Focus button when overlay appears (small delay to ensure DOM is ready)
    const timer = setTimeout(() => {
      buttonRef.current?.focus();
    }, 100);
    return () => clearTimeout(timer);
  }, [isMounted, hasConsent, contentWarning]);

  // Only render if contentWarning is true
  if (!contentWarning) {
    return null;
  }

  // Don't render until mounted (to avoid hydration mismatch)
  if (!isMounted) {
    return null;
  }

  // If user has consented, don't show overlay
  if (hasConsent) {
    return null;
  }

  return (
    <div
      className={[styles.overlay, className].filter(Boolean).join(' ') || undefined}
      onContextMenu={handleContextMenu}
      onDragStart={handleDragStart}
      role="dialog"
      aria-label="Content warning overlay"
      aria-modal="false"
    >
      <div className={styles.consentIconContainer}>
        <ConsentIcon />
        <p className={styles.consentMessage}>Sensitive Content</p>
      </div>
      <div className={styles.consentButtonContainer}>
        <button
          ref={buttonRef}
          type="button"
          onClick={handleAccept}
          className={styles.consentButton}
          aria-label="Accept and view sensitive content. Press Enter to unlock."
        >
          Unlock
        </button>
        <p className={styles.consentBottomMessage}>
          If you unlock this, you&apos;ll no longer see this warning message
        </p>
      </div>
    </div>
  );
}
